<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Spreadsheet Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="/style.css">
</head>

<body>
    <div class="container mt-5">
        <!-- Mode switch buttons -->
        <div class="btn-group mt-3" role="group" aria-label="Mode Switch">
            <button type="button" class="btn btn-primary" id="lightModeBtn">Light Mode</button>
            <button type="button" class="btn btn-secondary" id="darkModeBtn">Dark Mode</button>
        </div>

        <p id="food"></p>

        <p>
            <strong>This example is only going to work if it's on the internet or on a local server!</strong> To run a local server, run "terminal" or "command prompt" and run the command <code>python -m http.server</code> or <code>python -m SimpleHTTPServer</code> (whichever one works, really, and you might even need to <a href="http://littlecolumns.com/tools/python-wrangler/">install Python</a>). Then visit <a href="http://localhost:8000/">http://localhost:8000</a> and you'll be all set.
        </p>

        <h1 class="mt-5">Google Spreadsheet Search</h1>

        <form id="searchForm" class="mb-4">
            <div class="input-group">
                <input type="text" id="searchInput" class="form-control" placeholder="Enter keyword">
                <div class="input-group-append">
                    <button type="submit" class="btn btn-primary">Search</button>
                </div>
            </div>
        </form>

        <div id="loading" class="text-center d-none">
            <div class="spinner-border text-secondary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- Search results -->
        <div id="results" class="row mt-3 grid" data-masonry='{"percentPosition": true }'></div>

        <div id="noResults" class="alert alert-warning mt-3 d-none">
            No results found.
        </div>
    </div>

    <script>
        const public_spreadsheet_url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRDkvQQFQ_7x5bSb2q2eGwxuRJ-Wf50de_Wp1Kbf5F0I_h3M1fAnnLJfGzmP3reraU6SiM0qrKBw1s6/pub?gid=1048722892&single=true&output=csv';
        let cachedData = null;

        const showInfo = (results) => {
            const data = results.data ?? [];
            // data comes through as a simple array since simpleSheet is turned on
            alert(`Successfully processed ${data.length} rows!`)
            document.getElementById("food").innerHTML = `<strong>Example:</strong> ${[data[0].Name, data[1].Name, data[2].Name].join(", ")}`;
            console.log(data);
        }

        const init = () => {
            Papa.parse(public_spreadsheet_url, {
                download: true,
                header: true,
                complete: (results) => {
                    cachedData = results;
                    showInfo(results);
                }
            })
        }

        const displayResults = (data, keyword) => {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            // Filter data based on keyword, this checks if the keyword is present in the Name or Theme columns
            const filteredData = data.filter((item) => {
                return item.Name.toLowerCase().includes(keyword) || item.Theme.toLowerCase().includes(keyword);
            });

            // If no results found, display a message
            if (filteredData.length === 0) return resultsDiv.innerHTML = '<p class="alert alert-warning">No results found.</p>';

            filteredData.forEach((item) => {
                const nameElement = document.createElement('h3');
                nameElement.classList.add('card-title');
                nameElement.textContent = `Name: ${item.Name ?? 'N/A'}`;

                const imageElement = document.createElement('img');
                // Fix for cross-origin requests when loading images from Google Drive
                const driveFileID = extractGoogleDriveFileID(item['Id']);
                const imageUrl = `https://drive.google.com/thumbnail?id=${driveFileID}&amp;authuser=0&amp;sz=w200`;
                imageElement.src = imageUrl;
                imageElement.classList.add('figure-img', 'img-fluid', 'rounded');


                const figure = document.createElement('figure');
                figure.classList.add('figure', 'card-body');

                const figCaption = document.createElement('figcaption');
                figCaption.classList.add('figure-caption');
                figCaption.textContent = item.Name ?? 'image';

                figure.appendChild(imageElement);
                figure.appendChild(figCaption);

                const downloadLink = document.createElement('a');
                const downloadUrl = `https://drive.google.com/uc?id=${driveFileID}&export=download`;
                downloadLink.href = downloadUrl;
                downloadLink.textContent = 'Download Image';
                downloadLink.download = `${item.Name ?? 'image'}.jpg`;
                downloadLink.classList.add('btn', 'btn-primary', 'mt-2');

                const container = document.createElement('div');
                container.classList.add('card', 'border');
                container.appendChild(nameElement);

                container.innerHTML += '<div class="clearfix"></div>'; // Add clearfix class
                container.appendChild(figure);
                container.appendChild(downloadLink);

                resultsDiv.appendChild(container);
            });
        }

        const extractGoogleDriveFileID = (url) => {
            const match = url.match(/\/(?:open|uc)\?id=([^&]+)/);
            return match ? match[1] : url;
        }

        const searchGoogleSpreadsheet = (keyword) => {
            if (!cachedData) return alert('Data not loaded yet. Please try again.');
            displayResults(cachedData.data, keyword);
        }

        // Search form submission
        document.getElementById('searchForm').addEventListener('submit', (event) => {
            event.preventDefault();
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            searchGoogleSpreadsheet(searchTerm);
        });

        // Toggle between light mode and dark mode
        document.getElementById('lightModeBtn').addEventListener('click', () => {
            document.body.classList.remove('dark-mode');
        });

        document.getElementById('darkModeBtn').addEventListener('click', () => {
            document.body.classList.add('dark-mode');
        });

        window.addEventListener('DOMContentLoaded', init);
    </script>

    <!-- Masonry JavaScript library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/masonry/4.2.2/masonry.pkgd.min.js"></script>
    <script>
        // Initialize Masonry grid
        const masonry = new Masonry(document.querySelector('.grid'), {
            itemSelector: '.grid-item',
            columnWidth: '.grid-sizer',
            gutter: 20
        });
    </script>
</body>

</html>